# Bundle Size Check Workflow - taxbook-pro
# Generated: 2026-01-19
#
# Monitors JavaScript bundle size to prevent performance regressions.
# Features:
# - Builds Next.js app and analyzes bundle size
# - Compares against main branch baseline
# - Fails if total JS exceeds threshold (default: 500KB)
# - Comments on PR with detailed size breakdown
# - Tracks individual chunk sizes
#
# Place in: .github/workflows/bundle-size.yml

name: Bundle Size Check

on:
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'yarn.lock'
      - 'pnpm-lock.yaml'
      - 'src/**'
      - 'app/**'
      - 'pages/**'
      - 'components/**'
      - 'lib/**'
      - 'next.config.*'
      - 'tsconfig.json'
      - '.github/workflows/bundle-size.yml'

# Cancel in-progress runs for the same PR
concurrency:
  group: bundle-size-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  # Bundle size thresholds (in bytes)
  # Adjust these based on your application's requirements
  MAX_JS_SIZE: 512000  # 500KB default
  MAX_FIRST_LOAD_JS: 153600  # 150KB default
  WARN_THRESHOLD_PERCENT: 5  # Warn if increase exceeds 5%

jobs:
  # ============================================================
  # BUILD AND ANALYZE CURRENT BRANCH
  # ============================================================
  analyze-pr:
    name: Analyze PR Bundle
    runs-on: ubuntu-latest
    outputs:
      total_js_size: ${{ steps.analyze.outputs.total_js_size }}
      first_load_js: ${{ steps.analyze.outputs.first_load_js }}
      chunk_details: ${{ steps.analyze.outputs.chunk_details }}
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js app
        run: npm run build
        env:
          ANALYZE: true
          NODE_ENV: production

      - name: Analyze bundle size
        id: analyze
        run: |
          # Parse Next.js build output for bundle sizes
          # This extracts sizes from .next/build-manifest.json and server output

          echo "Analyzing bundle sizes..."

          # Get total JS size from .next/static/chunks
          TOTAL_JS_SIZE=0
          if [ -d ".next/static/chunks" ]; then
            TOTAL_JS_SIZE=$(find .next/static/chunks -name "*.js" -exec wc -c {} + | tail -1 | awk '{print $1}')
          fi
          echo "Total JS chunks: $TOTAL_JS_SIZE bytes"
          echo "total_js_size=$TOTAL_JS_SIZE" >> $GITHUB_OUTPUT

          # Parse route sizes from build output if available
          FIRST_LOAD_JS=0
          if [ -f ".next/build-manifest.json" ]; then
            # Extract main bundle sizes
            FIRST_LOAD_JS=$(node -e "
              const fs = require('fs');
              const manifest = JSON.parse(fs.readFileSync('.next/build-manifest.json', 'utf8'));
              const pages = manifest.pages || {};
              let totalFirstLoad = 0;

              // Get shared chunks (loaded on every page)
              const sharedChunks = pages['/_app'] || [];
              for (const chunk of sharedChunks) {
                const chunkPath = '.next/' + chunk;
                if (fs.existsSync(chunkPath)) {
                  totalFirstLoad += fs.statSync(chunkPath).size;
                }
              }

              console.log(totalFirstLoad);
            " 2>/dev/null || echo "0")
          fi
          echo "First load JS: $FIRST_LOAD_JS bytes"
          echo "first_load_js=$FIRST_LOAD_JS" >> $GITHUB_OUTPUT

          # Generate detailed chunk breakdown
          CHUNK_DETAILS=""
          if [ -d ".next/static/chunks" ]; then
            CHUNK_DETAILS=$(find .next/static/chunks -name "*.js" -printf "%s %f\n" | sort -rn | head -20 | while read size name; do
              size_kb=$(echo "scale=2; $size / 1024" | bc)
              echo "| $name | ${size_kb}KB |"
            done)
          fi

          # Store chunk details as multiline output
          echo "chunk_details<<EOF" >> $GITHUB_OUTPUT
          echo "$CHUNK_DETAILS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pr-bundle-stats
          path: |
            .next/build-manifest.json
            .next/static/chunks/*.js
          retention-days: 1

  # ============================================================
  # BUILD AND ANALYZE MAIN BRANCH (BASELINE)
  # ============================================================
  analyze-base:
    name: Analyze Base Bundle
    runs-on: ubuntu-latest
    outputs:
      total_js_size: ${{ steps.analyze.outputs.total_js_size }}
      first_load_js: ${{ steps.analyze.outputs.first_load_js }}
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js app
        run: npm run build
        env:
          NODE_ENV: production
        continue-on-error: true  # Base branch may not build if this is a new project

      - name: Analyze bundle size
        id: analyze
        run: |
          TOTAL_JS_SIZE=0
          if [ -d ".next/static/chunks" ]; then
            TOTAL_JS_SIZE=$(find .next/static/chunks -name "*.js" -exec wc -c {} + | tail -1 | awk '{print $1}')
          fi
          echo "total_js_size=$TOTAL_JS_SIZE" >> $GITHUB_OUTPUT

          FIRST_LOAD_JS=0
          if [ -f ".next/build-manifest.json" ]; then
            FIRST_LOAD_JS=$(node -e "
              const fs = require('fs');
              const manifest = JSON.parse(fs.readFileSync('.next/build-manifest.json', 'utf8'));
              const pages = manifest.pages || {};
              let totalFirstLoad = 0;
              const sharedChunks = pages['/_app'] || [];
              for (const chunk of sharedChunks) {
                const chunkPath = '.next/' + chunk;
                if (fs.existsSync(chunkPath)) {
                  totalFirstLoad += fs.statSync(chunkPath).size;
                }
              }
              console.log(totalFirstLoad);
            " 2>/dev/null || echo "0")
          fi
          echo "first_load_js=$FIRST_LOAD_JS" >> $GITHUB_OUTPUT

  # ============================================================
  # COMPARE AND REPORT
  # ============================================================
  compare:
    name: Compare Bundle Sizes
    runs-on: ubuntu-latest
    needs: [analyze-pr, analyze-base]
    steps:
      - name: Compare sizes and generate report
        id: compare
        run: |
          PR_SIZE=${{ needs.analyze-pr.outputs.total_js_size }}
          BASE_SIZE=${{ needs.analyze-base.outputs.total_js_size }}
          PR_FIRST_LOAD=${{ needs.analyze-pr.outputs.first_load_js }}
          BASE_FIRST_LOAD=${{ needs.analyze-base.outputs.first_load_js }}
          MAX_SIZE=${{ env.MAX_JS_SIZE }}
          MAX_FIRST_LOAD=${{ env.MAX_FIRST_LOAD_JS }}

          # Handle case where base branch has no build
          if [ "$BASE_SIZE" = "0" ] || [ -z "$BASE_SIZE" ]; then
            BASE_SIZE=0
            DIFF=0
            DIFF_PERCENT="N/A"
          else
            DIFF=$((PR_SIZE - BASE_SIZE))
            if [ "$BASE_SIZE" -gt 0 ]; then
              DIFF_PERCENT=$(echo "scale=2; ($DIFF * 100) / $BASE_SIZE" | bc)
            else
              DIFF_PERCENT="N/A"
            fi
          fi

          # Convert to KB for display
          PR_SIZE_KB=$(echo "scale=2; $PR_SIZE / 1024" | bc)
          BASE_SIZE_KB=$(echo "scale=2; $BASE_SIZE / 1024" | bc)
          DIFF_KB=$(echo "scale=2; $DIFF / 1024" | bc)
          MAX_SIZE_KB=$(echo "scale=2; $MAX_SIZE / 1024" | bc)

          # Determine status
          STATUS="success"
          STATUS_EMOJI="[OK]"

          if [ "$PR_SIZE" -gt "$MAX_SIZE" ]; then
            STATUS="failure"
            STATUS_EMOJI="[FAIL]"
          elif [ "$DIFF_PERCENT" != "N/A" ]; then
            THRESHOLD=${{ env.WARN_THRESHOLD_PERCENT }}
            if (( $(echo "$DIFF_PERCENT > $THRESHOLD" | bc -l) )); then
              STATUS="warning"
              STATUS_EMOJI="[WARN]"
            fi
          fi

          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "pr_size=$PR_SIZE" >> $GITHUB_OUTPUT
          echo "pr_size_kb=$PR_SIZE_KB" >> $GITHUB_OUTPUT
          echo "base_size_kb=$BASE_SIZE_KB" >> $GITHUB_OUTPUT
          echo "diff_kb=$DIFF_KB" >> $GITHUB_OUTPUT
          echo "diff_percent=$DIFF_PERCENT" >> $GITHUB_OUTPUT
          echo "status_emoji=$STATUS_EMOJI" >> $GITHUB_OUTPUT
          echo "max_size_kb=$MAX_SIZE_KB" >> $GITHUB_OUTPUT

      - name: Create PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const prSize = '${{ steps.compare.outputs.pr_size_kb }}';
            const baseSize = '${{ steps.compare.outputs.base_size_kb }}';
            const diffKb = '${{ steps.compare.outputs.diff_kb }}';
            const diffPercent = '${{ steps.compare.outputs.diff_percent }}';
            const status = '${{ steps.compare.outputs.status }}';
            const statusEmoji = '${{ steps.compare.outputs.status_emoji }}';
            const maxSize = '${{ steps.compare.outputs.max_size_kb }}';
            const chunkDetails = `${{ needs.analyze-pr.outputs.chunk_details }}`;

            // Determine status icon
            let statusIcon = '';
            if (status === 'success') {
              statusIcon = '[PASS]';
            } else if (status === 'warning') {
              statusIcon = '[WARN]';
            } else {
              statusIcon = '[FAIL]';
            }

            // Format diff display
            let diffDisplay = '';
            if (parseFloat(diffKb) > 0) {
              diffDisplay = `+${diffKb}KB (+${diffPercent}%)`;
            } else if (parseFloat(diffKb) < 0) {
              diffDisplay = `${diffKb}KB (${diffPercent}%)`;
            } else {
              diffDisplay = 'No change';
            }

            const comment = `## ${statusIcon} Bundle Size Report

            | Metric | PR | Base | Diff | Threshold |
            |--------|----|----- |------|-----------|
            | Total JS | ${prSize}KB | ${baseSize}KB | ${diffDisplay} | ${maxSize}KB |

            <details>
            <summary>Largest Chunks (Top 20)</summary>

            | Chunk | Size |
            |-------|------|
            ${chunkDetails || '| No chunks found | - |'}

            </details>

            ---
            <sub>Bundle size checked by GitHub Actions</sub>`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Bundle Size Report')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Check threshold
        run: |
          STATUS="${\{ steps.compare.outputs.status }}"
          PR_SIZE="${\{ steps.compare.outputs.pr_size }}"
          MAX_SIZE="${\{ env.MAX_JS_SIZE }}"

          if [ "$STATUS" = "failure" ]; then
            echo "Bundle size (${PR_SIZE} bytes) exceeds threshold (${MAX_SIZE} bytes)"
            exit 1
          fi

          echo "Bundle size check passed"

# ============================================================
# ALTERNATIVE: SIZE-LIMIT CONFIGURATION
# ============================================================
# If you prefer using size-limit instead of custom analysis,
# add the following to your package.json:
#
# {
#   "size-limit": [
#     {
#       "path": ".next/static/chunks/*.js",
#       "limit": "500 KB"
#     },
#     {
#       "path": ".next/static/chunks/pages/_app-*.js",
#       "limit": "150 KB"
#     }
#   ],
#   "devDependencies": {
#     "@size-limit/preset-app": "^11.0.0",
#     "size-limit": "^11.0.0"
#   }
# }
#
# Then replace the analyze steps with:
#
# - name: Run size-limit
#   uses: andresz1/size-limit-action@v1
#   with:
#     github_token: ${{ secrets.GITHUB_TOKEN }}

# ============================================================
# ALTERNATIVE: @NEXT/BUNDLE-ANALYZER CONFIGURATION
# ============================================================
# To use @next/bundle-analyzer for visual bundle analysis:
#
# 1. Install: npm install @next/bundle-analyzer
#
# 2. Update next.config.js:
#
# const withBundleAnalyzer = require('@next/bundle-analyzer')({
#   enabled: process.env.ANALYZE === 'true',
# });
#
# module.exports = withBundleAnalyzer({
#   // your existing config
# });
#
# 3. Add an additional step to upload the analyzer output:
#
# - name: Upload bundle analysis
#   uses: actions/upload-artifact@v4
#   with:
#     name: bundle-analysis
#     path: .next/analyze/
#     retention-days: 7

# ============================================================
# GENERATED BY MENTAL MODELS SDLC
# ============================================================
