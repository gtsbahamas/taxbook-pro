# Penetration Testing Runbook - taxbook-pro

> Step-by-step guide for security testing. Use for internal security reviews or to guide external penetration testers.

---

## Scope Definition Template

### In Scope

| Asset | Type | URL/Location |
|-------|------|--------------|
| Web Application | Primary | https://taxbook-pro.vercel.app |
| API Endpoints | REST | /api/* |
| Authentication | OAuth/Email | /login, /signup, /api/auth/* |
| Database | PostgreSQL | Via application only (no direct access) |

### Out of Scope

- Third-party services (Supabase infrastructure, Vercel)
- Social engineering
- Physical security
- Denial of Service attacks
- Other customers' data

### Test Accounts

| Role | Email | Purpose |
|------|-------|---------|
| Regular User | pentest-user@example.com | Standard user testing |
| Admin User | pentest-admin@example.com | Admin function testing |
| No Account | N/A | Unauthenticated testing |

---

## Authentication Testing Checklist

### Password Security

- [ ] **Brute force protection**
  ```bash
  # Attempt 10 failed logins
  for i in {1..10}; do
    curl -X POST /api/auth/login \
      -d '{"email":"test@example.com","password":"wrong'$i'"}' \
      -H "Content-Type: application/json"
  done
  # Expected: Rate limiting kicks in after ~5 attempts
  ```

- [ ] **Weak password acceptance**
  ```bash
  # Try weak passwords
  curl -X POST /api/auth/signup \
    -d '{"email":"test@example.com","password":"123456"}' \
    -H "Content-Type: application/json"
  # Expected: Rejected with password policy error
  ```

- [ ] **Password enumeration**
  ```bash
  # Compare responses for existing vs non-existing users
  curl -X POST /api/auth/login -d '{"email":"exists@example.com","password":"wrong"}'
  curl -X POST /api/auth/login -d '{"email":"notexists@example.com","password":"wrong"}'
  # Expected: Same response/timing for both
  ```

### Session Management

- [ ] **Session fixation**
  1. Note session token before login
  2. Login successfully
  3. Check if session token changed
  Expected: New session token after login

- [ ] **Session timeout**
  1. Login and get session
  2. Wait beyond timeout period
  3. Attempt to use session
  Expected: Session rejected after timeout

- [ ] **Logout effectiveness**
  1. Login and save session token
  2. Logout
  3. Attempt to use old session token
  Expected: Token rejected after logout

### OAuth Testing (if enabled)

- [ ] **State parameter validation**
- [ ] **Redirect URI validation**
- [ ] **Token exchange security**

---

## Authorization Testing (IDOR, Privilege Escalation)

### Insecure Direct Object Reference (IDOR)

#### Profile IDOR Tests

```bash
# 1. Create as User A
TOKEN_A=$(login user_a)
ITEM_ID=$(curl -X POST /api/profile \
  -H "Authorization: Bearer $TOKEN_A" \
  -d '{"name":"Test Item"}' | jq -r '.id')

# 2. Attempt access as User B
TOKEN_B=$(login user_b)
curl -X GET /api/profile/$ITEM_ID \
  -H "Authorization: Bearer $TOKEN_B"
# Expected: 404 Not Found (not 403)

# 3. Attempt update as User B
curl -X PATCH /api/profile/$ITEM_ID \
  -H "Authorization: Bearer $TOKEN_B" \
  -d '{"name":"Hacked"}'
# Expected: 404 Not Found

# 4. Attempt delete as User B
curl -X DELETE /api/profile/$ITEM_ID \
  -H "Authorization: Bearer $TOKEN_B"
# Expected: 404 Not Found
```

#### Client IDOR Tests

```bash
# 1. Create as User A
TOKEN_A=$(login user_a)
ITEM_ID=$(curl -X POST /api/client \
  -H "Authorization: Bearer $TOKEN_A" \
  -d '{"name":"Test Item"}' | jq -r '.id')

# 2. Attempt access as User B
TOKEN_B=$(login user_b)
curl -X GET /api/client/$ITEM_ID \
  -H "Authorization: Bearer $TOKEN_B"
# Expected: 404 Not Found (not 403)

# 3. Attempt update as User B
curl -X PATCH /api/client/$ITEM_ID \
  -H "Authorization: Bearer $TOKEN_B" \
  -d '{"name":"Hacked"}'
# Expected: 404 Not Found

# 4. Attempt delete as User B
curl -X DELETE /api/client/$ITEM_ID \
  -H "Authorization: Bearer $TOKEN_B"
# Expected: 404 Not Found
```

#### Service IDOR Tests

```bash
# 1. Create as User A
TOKEN_A=$(login user_a)
ITEM_ID=$(curl -X POST /api/service \
  -H "Authorization: Bearer $TOKEN_A" \
  -d '{"name":"Test Item"}' | jq -r '.id')

# 2. Attempt access as User B
TOKEN_B=$(login user_b)
curl -X GET /api/service/$ITEM_ID \
  -H "Authorization: Bearer $TOKEN_B"
# Expected: 404 Not Found (not 403)

# 3. Attempt update as User B
curl -X PATCH /api/service/$ITEM_ID \
  -H "Authorization: Bearer $TOKEN_B" \
  -d '{"name":"Hacked"}'
# Expected: 404 Not Found

# 4. Attempt delete as User B
curl -X DELETE /api/service/$ITEM_ID \
  -H "Authorization: Bearer $TOKEN_B"
# Expected: 404 Not Found
```

#### Appointment IDOR Tests

```bash
# 1. Create as User A
TOKEN_A=$(login user_a)
ITEM_ID=$(curl -X POST /api/appointment \
  -H "Authorization: Bearer $TOKEN_A" \
  -d '{"name":"Test Item"}' | jq -r '.id')

# 2. Attempt access as User B
TOKEN_B=$(login user_b)
curl -X GET /api/appointment/$ITEM_ID \
  -H "Authorization: Bearer $TOKEN_B"
# Expected: 404 Not Found (not 403)

# 3. Attempt update as User B
curl -X PATCH /api/appointment/$ITEM_ID \
  -H "Authorization: Bearer $TOKEN_B" \
  -d '{"name":"Hacked"}'
# Expected: 404 Not Found

# 4. Attempt delete as User B
curl -X DELETE /api/appointment/$ITEM_ID \
  -H "Authorization: Bearer $TOKEN_B"
# Expected: 404 Not Found
```

#### Availability IDOR Tests

```bash
# 1. Create as User A
TOKEN_A=$(login user_a)
ITEM_ID=$(curl -X POST /api/availability \
  -H "Authorization: Bearer $TOKEN_A" \
  -d '{"name":"Test Item"}' | jq -r '.id')

# 2. Attempt access as User B
TOKEN_B=$(login user_b)
curl -X GET /api/availability/$ITEM_ID \
  -H "Authorization: Bearer $TOKEN_B"
# Expected: 404 Not Found (not 403)

# 3. Attempt update as User B
curl -X PATCH /api/availability/$ITEM_ID \
  -H "Authorization: Bearer $TOKEN_B" \
  -d '{"name":"Hacked"}'
# Expected: 404 Not Found

# 4. Attempt delete as User B
curl -X DELETE /api/availability/$ITEM_ID \
  -H "Authorization: Bearer $TOKEN_B"
# Expected: 404 Not Found
```

#### Document IDOR Tests

```bash
# 1. Create as User A
TOKEN_A=$(login user_a)
ITEM_ID=$(curl -X POST /api/document \
  -H "Authorization: Bearer $TOKEN_A" \
  -d '{"name":"Test Item"}' | jq -r '.id')

# 2. Attempt access as User B
TOKEN_B=$(login user_b)
curl -X GET /api/document/$ITEM_ID \
  -H "Authorization: Bearer $TOKEN_B"
# Expected: 404 Not Found (not 403)

# 3. Attempt update as User B
curl -X PATCH /api/document/$ITEM_ID \
  -H "Authorization: Bearer $TOKEN_B" \
  -d '{"name":"Hacked"}'
# Expected: 404 Not Found

# 4. Attempt delete as User B
curl -X DELETE /api/document/$ITEM_ID \
  -H "Authorization: Bearer $TOKEN_B"
# Expected: 404 Not Found
```


### Privilege Escalation

```bash
# Attempt to access admin endpoints as regular user
curl -X GET /api/admin/users \
  -H "Authorization: Bearer $REGULAR_USER_TOKEN"
# Expected: 403 Forbidden

# Attempt to modify own role
curl -X PATCH /api/users/me \
  -H "Authorization: Bearer $REGULAR_USER_TOKEN" \
  -d '{"role":"admin"}'
# Expected: 403 or field ignored
```

### Horizontal Privilege Escalation

```bash
# List only returns own data
curl -X GET /api/profile \
  -H "Authorization: Bearer $TOKEN"
# Expected: Only authenticated user's items

# Cannot enumerate other users' IDs
for id in $(seq 1 100); do
  curl -X GET /api/profile/$id \
    -H "Authorization: Bearer $TOKEN"
done
# Expected: Only own items return 200
```

---

## Input Validation Testing

### SQL Injection

```bash
# Test common payloads
PAYLOADS=(
  "' OR '1'='1"
  "'; DROP TABLE users; --"
  "1; SELECT * FROM users"
  "' UNION SELECT * FROM users --"
)

for payload in "${PAYLOADS[@]}"; do
  curl -X GET "/api/profile?search=$payload" \
    -H "Authorization: Bearer $TOKEN"
done
# Expected: All return validation errors or empty results, no SQL execution

# In JSON body
curl -X POST /api/profile \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "test'"'"'; DROP TABLE users; --"}'
# Expected: Validation error or escaped storage
```

### XSS (Cross-Site Scripting)

```bash
# Stored XSS
curl -X POST /api/profile \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"name": "<script>alert(1)</script>"}'

# Then view the page to see if script executes
# Expected: Script is escaped in output

# Other payloads
PAYLOADS=(
  "<img src=x onerror=alert(1)>"
  "<svg onload=alert(1)>"
  "javascript:alert(1)"
  "'><script>alert(1)</script>"
)
```

### Command Injection

If any endpoints accept commands or filenames:
```bash
curl -X POST /api/process \
  -d '{"filename": "test.txt; rm -rf /"}'
# Expected: Validation error, command not executed
```

### Path Traversal

```bash
# If file access endpoints exist
curl -X GET /api/files/../../../etc/passwd
curl -X GET /api/files/....//....//etc/passwd
# Expected: 400 Bad Request or access denied
```

---

## API Security Testing

### Rate Limiting

```bash
# Rapid-fire requests
for i in {1..100}; do
  curl -X GET /api/profile \
    -H "Authorization: Bearer $TOKEN" &
done
wait
# Expected: 429 Too Many Requests after limit

# Check headers
curl -I /api/profile \
  -H "Authorization: Bearer $TOKEN"
# Expected: X-RateLimit-* headers present
```

### Mass Assignment

```bash
# Attempt to set protected fields
curl -X POST /api/profile \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "name": "Test",
    "id": "custom-id",
    "user_id": "other-user-id",
    "created_at": "2020-01-01",
    "role": "admin"
  }'
# Expected: Protected fields ignored or rejected
```

### API Versioning/Deprecation

```bash
# Check for old API versions
curl -X GET /api/v1/profile
curl -X GET /api/v0/profile
# Expected: 404 or properly deprecated responses
```

---

## Entity-Specific Attack Vectors

### Profile

**Fields to test:**
- `id` (string): XSS, SQL injection, length limits
- `user_id` (string): XSS, SQL injection, length limits
- `email` (string): XSS, SQL injection, length limits
- `name` (string): XSS, SQL injection, length limits
- `firm_name` (string): XSS, SQL injection, length limits
- `license_number` (string): XSS, SQL injection, length limits
- `timezone` (string): XSS, SQL injection, length limits
- `subscription_tier` (string): XSS, SQL injection, length limits
- `booking_slug` (string): XSS, SQL injection, length limits
- `tax_season_start` (Date): Type validation
- `tax_season_end` (Date): Type validation
- `max_daily_appointments` (number): Integer overflow, negative values
- `max_daily_appointments_tax_season` (number): Integer overflow, negative values
- `created_at` (Date): Type validation
- `updated_at` (Date): Type validation

**Business logic tests:**
- Ownership bypass: Can user claim another user's Profile? (if user-owned)

**Sample test:**
```bash
# Boundary testing
curl -X POST /api/profile \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "id": "[10000 character string]",
    "user_id": "[10000 character string]",
    "email": "[10000 character string]",
    "name": "[10000 character string]",
    "firm_name": "[10000 character string]",
    "license_number": "[10000 character string]",
    "timezone": "[10000 character string]",
    "subscription_tier": "[10000 character string]",
    "booking_slug": "[10000 character string]",
    "max_daily_appointments": 999999999999999,
        "max_daily_appointments_tax_season": 999999999999999,
      }'
# Expected: Validation error for exceeding limits
```

### Client

**Fields to test:**
- `id` (string): XSS, SQL injection, length limits
- `user_id` (string): XSS, SQL injection, length limits
- `name` (string): XSS, SQL injection, length limits
- `email` (string): XSS, SQL injection, length limits
- `phone` (string): XSS, SQL injection, length limits
- `tax_id_last4` (string): XSS, SQL injection, length limits
- `filing_status` (string): XSS, SQL injection, length limits
- `preferred_contact` (string): XSS, SQL injection, length limits
- `notes` (string): XSS, SQL injection, length limits
- `created_at` (Date): Type validation
- `updated_at` (Date): Type validation

**Business logic tests:**
- Ownership bypass: Can user claim another user's Client? (if user-owned)

**Sample test:**
```bash
# Boundary testing
curl -X POST /api/client \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "id": "[10000 character string]",
    "user_id": "[10000 character string]",
    "name": "[10000 character string]",
    "email": "[10000 character string]",
    "phone": "[10000 character string]",
    "tax_id_last4": "[10000 character string]",
    "filing_status": "[10000 character string]",
    "preferred_contact": "[10000 character string]",
    "notes": "[10000 character string]",
  }'
# Expected: Validation error for exceeding limits
```

### Service

**Fields to test:**
- `id` (string): XSS, SQL injection, length limits
- `user_id` (string): XSS, SQL injection, length limits
- `name` (string): XSS, SQL injection, length limits
- `description` (string): XSS, SQL injection, length limits
- `duration_minutes` (number): Integer overflow, negative values
- `price` (number): Integer overflow, negative values
- `tax_season_only` (boolean): Type coercion
- `requires_documents` (boolean): Type coercion
- `is_active` (boolean): Type coercion
- `buffer_minutes` (number): Integer overflow, negative values
- `created_at` (Date): Type validation
- `updated_at` (Date): Type validation

**Business logic tests:**
- Ownership bypass: Can user claim another user's Service? (if user-owned)

**Sample test:**
```bash
# Boundary testing
curl -X POST /api/service \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "id": "[10000 character string]",
    "user_id": "[10000 character string]",
    "name": "[10000 character string]",
    "description": "[10000 character string]",
    "duration_minutes": 999999999999999,
        "price": 999999999999999,
        "buffer_minutes": 999999999999999,
      }'
# Expected: Validation error for exceeding limits
```

### Appointment

**Fields to test:**
- `id` (string): XSS, SQL injection, length limits
- `user_id` (string): XSS, SQL injection, length limits
- `client_id` (string): XSS, SQL injection, length limits
- `service_id` (string): XSS, SQL injection, length limits
- `starts_at` (Date): Type validation
- `ends_at` (Date): Type validation
- `status` (string): XSS, SQL injection, length limits
- `notes` (string): XSS, SQL injection, length limits
- `meeting_link` (string): XSS, SQL injection, length limits
- `reminder_sent_24h` (boolean): Type coercion
- `reminder_sent_1h` (boolean): Type coercion
- `cancellation_reason` (string): XSS, SQL injection, length limits
- `created_at` (Date): Type validation
- `updated_at` (Date): Type validation

**Business logic tests:**
- State transition bypass: Can user skip states?
- Invalid state values: What happens with custom state values?
- Ownership bypass: Can user claim another user's Appointment? (if user-owned)

**Sample test:**
```bash
# Boundary testing
curl -X POST /api/appointment \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "id": "[10000 character string]",
    "user_id": "[10000 character string]",
    "client_id": "[10000 character string]",
    "service_id": "[10000 character string]",
    "status": "[10000 character string]",
    "notes": "[10000 character string]",
    "meeting_link": "[10000 character string]",
    "cancellation_reason": "[10000 character string]",
  }'
# Expected: Validation error for exceeding limits
```

### Availability

**Fields to test:**
- `id` (string): XSS, SQL injection, length limits
- `user_id` (string): XSS, SQL injection, length limits
- `day_of_week` (number): Integer overflow, negative values
- `start_time` (string): XSS, SQL injection, length limits
- `end_time` (string): XSS, SQL injection, length limits
- `is_tax_season` (boolean): Type coercion
- `created_at` (Date): Type validation
- `updated_at` (Date): Type validation

**Business logic tests:**
- Ownership bypass: Can user claim another user's Availability? (if user-owned)

**Sample test:**
```bash
# Boundary testing
curl -X POST /api/availability \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "id": "[10000 character string]",
    "user_id": "[10000 character string]",
    "day_of_week": 999999999999999,
        "start_time": "[10000 character string]",
    "end_time": "[10000 character string]",
  }'
# Expected: Validation error for exceeding limits
```

### Document

**Fields to test:**
- `id` (string): XSS, SQL injection, length limits
- `user_id` (string): XSS, SQL injection, length limits
- `client_id` (string): XSS, SQL injection, length limits
- `appointment_id` (string): XSS, SQL injection, length limits
- `document_type` (string): XSS, SQL injection, length limits
- `file_url` (string): XSS, SQL injection, length limits
- `file_name` (string): XSS, SQL injection, length limits
- `status` (string): XSS, SQL injection, length limits
- `tax_year` (number): Integer overflow, negative values
- `notes` (string): XSS, SQL injection, length limits
- `rejection_reason` (string): XSS, SQL injection, length limits
- `created_at` (Date): Type validation
- `updated_at` (Date): Type validation

**Business logic tests:**
- State transition bypass: Can user skip states?
- Invalid state values: What happens with custom state values?
- Ownership bypass: Can user claim another user's Document? (if user-owned)

**Sample test:**
```bash
# Boundary testing
curl -X POST /api/document \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "id": "[10000 character string]",
    "user_id": "[10000 character string]",
    "client_id": "[10000 character string]",
    "appointment_id": "[10000 character string]",
    "document_type": "[10000 character string]",
    "file_url": "[10000 character string]",
    "file_name": "[10000 character string]",
    "status": "[10000 character string]",
    "tax_year": 999999999999999,
        "notes": "[10000 character string]",
    "rejection_reason": "[10000 character string]",
  }'
# Expected: Validation error for exceeding limits
```


---

## Reporting Template

### Vulnerability Report

```markdown
## Vulnerability: [Title]

### Severity
[Critical/High/Medium/Low/Informational]

### CVSS Score
[0.0 - 10.0]

### Description
[What is the vulnerability]

### Affected Component
[URL, endpoint, or code location]

### Steps to Reproduce
1. [Step 1]
2. [Step 2]
3. [Step 3]

### Proof of Concept
[Code, screenshot, or video]

### Impact
[What an attacker could do]

### Remediation
[How to fix it]

### References
- [OWASP link]
- [CWE link]
```

### Executive Summary Template

```markdown
## Penetration Test Summary

**Date:** [Date]
**Tester:** [Name/Company]
**Scope:** [What was tested]

### Key Findings

| Severity | Count |
|----------|-------|
| Critical | 0 |
| High | 0 |
| Medium | 0 |
| Low | 0 |

### Critical/High Findings
[List of critical and high findings with brief descriptions]

### Recommendations
1. [Priority 1]
2. [Priority 2]
3. [Priority 3]

### Overall Security Posture
[Assessment of overall security]
```

---

## Tools Recommended

| Category | Tool | Purpose |
|----------|------|---------|
| Proxy | Burp Suite / OWASP ZAP | Request interception |
| Scanner | Nuclei | Automated vulnerability scanning |
| API Testing | Postman / Insomnia | API exploration |
| SQL Injection | sqlmap | Automated SQL injection |
| XSS | XSStrike | XSS detection |
| Fuzzing | ffuf | Directory/parameter fuzzing |

---

## Post-Test Cleanup

- [ ] Remove all test accounts
- [ ] Delete test data created during testing
- [ ] Revoke any temporary access
- [ ] Document any changes made to the system
- [ ] Notify team of completion
